{% extends "base.html" %}

{% block content %}
<div class="task-detail">
    <div class="task-header">
        <h2>{{ task.title }}</h2>
        <div class="task-actions">
            <a href="{{ url_for('task_list') }}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
    
    <div class="task-content">
        <div class="task-info">
            <p><strong>Description:</strong> {{ task.description or 'No description' }}</p>
            <p><strong>Status:</strong> 
                <select id="statusSelect">
                    <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
                    <option value="in-progress" {% if task.status == 'in-progress' %}selected{% endif %}>In Progress</option>
                    <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
                </select>
            </p>
            <p><strong>Assignee:</strong> {{ task.assignee.username if task.assignee else 'Unassigned' }}</p>
            <p><strong>Due Date:</strong> {{ task.due_date.strftime('%Y-%m-%d') if task.due_date else 'No due date' }}</p>
            <p><strong>Created:</strong> {{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
            <p><strong>Last Updated:</strong> {{ task.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
        </div>
        
        <div class="detail-actions">
            <button onclick="updateTaskStatus()" class="btn btn-primary">Update Status</button>
            {% if task.status != 'done' %}
            <button onclick="completeTask()" class="btn btn-success">Complete Task</button>
            {% endif %}
            <button onclick="deleteTask()" class="btn btn-danger">Delete Task</button>
        </div>
    </div>
</div>

<script>
    function updateTaskStatus() {
        const newStatus = document.getElementById('statusSelect').value;
        
        fetch(`/api/tasks/{{ task.id }}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(task => {
            alert('Status updated successfully!');
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating status');
        });
    }
    
    function completeTask() {
        if (confirm('Mark this task as completed?')) {
            fetch(`/api/tasks/{{ task.id }}/complete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(task => {
                alert('Task marked as completed!');
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error completing task');
            });
        }
    }
    
    function deleteTask() {
        if (confirm('Are you sure you want to delete this task?')) {
            fetch(`/api/tasks/{{ task.id }}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert('Task deleted successfully!');
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting task');
            });
        }
    }
</script>
{% endblock %}