{% extends "base.html" %}

{% block content %}
<div class="task-header">
    <h2>Task List</h2>
    <a href="{{ url_for('add_task_form') }}" class="btn btn-primary">Add New Task</a>
</div>

<div class="filters">
    <button class="filter-btn active" data-filter="all">All Tasks</button>
    <button class="filter-btn" data-filter="assigned_to_me">Assigned to Me</button>
    <button class="filter-btn" data-filter="completed">Completed</button>
</div>

<div class="task-list" id="taskList">

</div>

<script>
    const currentUserId = 1; 
    
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks('all');
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadTasks(this.dataset.filter);
            });
        });
    });

    function loadTasks(filter) {
        let url = `/api/tasks?filter=${filter}`;
        if (filter === 'assigned_to_me') {
            url += `&user_id=${currentUserId}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(tasks => {
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = tasks.map(task => `
                    <div class="task-card ${task.status}" id="task-${task.id}">
                        <div class="task-header">
                            <h3>${task.title}</h3>
                            <span class="status-badge ${task.status}">${task.status}</span>
                        </div>
                        <p class="task-description">${task.description || 'No description'}</p>
                        <div class="task-meta">
                            <span>Assignee: ${task.assignee_name}</span>
                            <span>Due: ${task.due_date || 'No due date'}</span>
                        </div>
                        <div class="task-actions">
                            <a href="/tasks/${task.id}" class="btn btn-secondary">View Details</a>
                            ${task.status !== 'done' ? 
                                `<button onclick="completeTask(${task.id})" class="btn btn-success">Complete Task</button>` 
                                : ''}
                            <button onclick="deleteTask(${task.id})" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            });
    }

    function completeTask(taskId) {
        if (confirm('Mark this task as completed?')) {
            fetch(`/api/tasks/${taskId}/complete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(task => {
                alert('Task marked as completed!');
      
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                loadTasks(activeFilter);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error completing task');
            });
        }
    }

    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert('Task deleted successfully!');
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                loadTasks(activeFilter);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting task');
            });
        }
    }
</script>
{% endblock %}